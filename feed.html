<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>My Feed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <style>
        /* Hide scrollbar for cleaner mobile look */
        body::-webkit-scrollbar {
            display: none;
        }

        .tap-highlight-transparent {
            -webkit-tap-highlight-color: transparent;
        }

        /* Navbar Styles from index.html for consistency */
        .navbar {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 15px;
            background: rgba(15, 23, 42, 0.95);
            /* slate-900/95 */
            backdrop-filter: blur(10px);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-sizing: border-box;
            padding-top: calc(15px + env(safe-area-inset-top));
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-link:hover,
        .nav-link.active {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
    </style>

</head>

<body class="bg-slate-900 text-slate-200 min-h-screen font-sans">

    <nav class="navbar">
        <a href="index.html" class="nav-link">
            <span>üéôÔ∏è</span> <span>Record</span>
        </a>
        <a href="feed.html" class="nav-link active">
            <span>üì±</span> <span>Feed</span>
        </a>
        <button id="nostrLoginBtn" class="nav-link" style="background: #a855f7; color: white; margin-left: auto;">
            Login
        </button>
    </nav>

    <div id="feed-container" class="max-w-xl mx-auto pb-20 px-0"
        style="padding-top: calc(6rem + env(safe-area-inset-top));">
        <div class="text-center mt-10 text-slate-500 animate-pulse">Loading feed...</div>
    </div>

    <!-- Load Nostr Tools for decoding NPUBs -->
    <script src="https://unpkg.com/nostr-tools/lib/nostr.bundle.js"></script>

    <script>
        // Global Store
        window.postsById = {};
        let pool = null; // Global Pool to persist connections

        // --- CONFIGURATION ---
        const BOT_NPUB = 'npub1892qylqredhs7p4nwa3ka6aljmgdhv7q2j5xan3ce2s66csysl0q69g6zj';
        const RELAYS = ['wss://relay.damus.io', 'wss://relay.primal.net', 'wss://nos.lol'];

        // Dynamically fetch feed files from the /feed/ directory
        async function getFeedFiles() {
            return [
                'feed/AI_Curator_feed.json',
                'feed/News_Bot_feed.json',
                'feed/NAND_Bot_feed.json',
                'feed/MySky_Bot_feed.json'
            ];
        }
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyd-xD0xTYGNsyflEBFpHXD8nbkI6RKAFJ1WMKgUGOiy4DTNVEElxiuUIwT6RM_meZrtg/exec';

        // --- AUTHENTICATION LOGIC (NOSTR) ---
        const nostrLoginBtn = document.getElementById('nostrLoginBtn');
        let userPubkey = localStorage.getItem('nostr_pubkey');

        function updateLoginUI() {
            if (userPubkey) {
                nostrLoginBtn.innerText = `Logged in`;
                nostrLoginBtn.style.background = '#22c55e';
                nostrLoginBtn.disabled = true;
                // Trigger private fetch if logged in
                setTimeout(fetchInsights, 1000);
            } else {
                nostrLoginBtn.innerText = 'Login with Nostr';
                nostrLoginBtn.style.background = '#a855f7';
                nostrLoginBtn.disabled = false;
            }
        }

        // Helper: Decode NPUB to HEX
        function getNpubHex(npub) {
            try {
                if (!window.NostrTools) return null;
                const { type, data } = window.NostrTools.nip19.decode(npub);
                return data;
            } catch (e) {
                console.error("Error decoding NPUB:", e);
                return null;
            }
        }

        nostrLoginBtn.addEventListener('click', async () => {
            if (!window.nostr) {
                alert("Nostr extension not found! Please install nos2x or similar.");
                return;
            }
            try {
                userPubkey = await window.nostr.getPublicKey();
                localStorage.setItem('nostr_pubkey', userPubkey);
                updateLoginUI();
            } catch (err) {
                console.error(err);
                alert("Login failed");
            }
        });

        // --- 2. FETCH INSIGHTS (KIND 10001) ---
        async function fetchInsights() {
            if (!userPubkey) return; // Needs login
            if (!window.NostrTools) {
                // Wait for lib to load
                console.log("Waiting for NostrTools...");
                setTimeout(fetchInsights, 500);
                return;
            }

            // Init Global Pool
            if (!pool) {
                pool = new window.NostrTools.SimplePool();
            }

            // 1. Get Bot Hex
            const botHex = getNpubHex(BOT_NPUB);
            if (!botHex) {
                console.error("Failed to decode Bot NPUB");
                return;
            }

            // 2. Get User Hex (Ensure it's Hex!)
            let userHex = userPubkey;
            if (userPubkey.startsWith('npub')) {
                userHex = getNpubHex(userPubkey);
                console.log("Converted User NPUB to Hex:", userHex);
            }

            console.log("ü§ñ Fetching Insights...");
            console.log("   > Bot (Author):", botHex);
            console.log("   > User (Target):", userHex);

            const filter = {
                authors: [botHex],
                kinds: [10001],
                '#p': [userHex],
                limit: 50
            };

            console.log("   > Filter:", JSON.stringify(filter));

            try {
                let events = [];

                // COMPATIBILITY FIX: Check API Version
                // v2.7+: .list()
                // v2.0-v2.6: .subscribeMany()
                // v1.x: .sub()

                if (typeof pool.list === 'function') {
                    console.log("Using pool.list() (Newer API)");
                    events = await pool.list(RELAYS, [filter]);

                } else if (typeof pool.subscribeMany === 'function') {
                    console.log("Using pool.subscribeMany() (v2 Standard)");

                    // subscribeMany returns a cleanup function, not a promise of events
                    events = await new Promise((resolve) => {
                        const collected = [];
                        let sub;
                        let resolved = false;

                        const finish = () => {
                            if (resolved) return;
                            resolved = true;
                            if (sub && sub.close) sub.close();
                            resolve(collected);
                        };

                        // Callback handlers
                        const onevent = (event) => collected.push(event);
                        const oneose = () => {
                            // EOSE received - resolving
                            console.log("‚úÖ EOSE received (waiting for timeout/others).");
                            // finish(); // Don't close on first EOSE to wait for all relays
                        };

                        sub = pool.subscribeMany(RELAYS, filter, {
                            onevent,
                            oneose
                        });

                        // Hard timeout to resolve
                        setTimeout(() => {
                            if (!resolved) {
                                console.log("‚è≥ Timeout reached (subscribeMany).");
                                finish();
                            }
                        }, 3500);
                    });

                } else if (typeof pool.sub === 'function') {
                    console.log("Using pool.sub() (Legacy v1.x)");
                    events = await new Promise((resolve) => {
                        const sub = pool.sub(RELAYS, [filter]);
                        const collected = [];

                        sub.on('event', (event) => {
                            collected.push(event);
                        });

                        // v1 SimplePool fires 'eose'
                        sub.on('eose', () => {
                            if (sub.unsub) sub.unsub();
                            resolve(collected);
                        });

                        setTimeout(() => {
                            if (sub.unsub) sub.unsub();
                            resolve(collected);
                        }, 3500);
                    });
                } else {
                    console.error("Unknown SimplePool API. Keys:", Object.keys(pool));
                }

                console.log(`‚ú® Found ${events.length} insights.`);

                if (events.length === 0) {
                    console.log("No insights found.");
                }

                // Sort by date desc
                events.sort((a, b) => b.created_at - a.created_at);

                for (const ev of events) {
                    await processInsightEvent(ev, botHex);
                }

            } catch (e) {
                console.error("Error fetching insights:", e);
            }
            // DO NOT CLOSE POOL if using global pool
        }

        // Deduplication Set
        window.processedEventIds = new Set();

        async function processInsightEvent(event, botHex) {
            try {
                // optimize: avoid re-decrypting same event
                if (window.processedEventIds.has(event.id)) return;
                window.processedEventIds.add(event.id);

                // Decrypt
                if (!window.nostr) return;

                // We assume NIP-44 encryption now
                const decrypted = await window.nostr.nip44.decrypt(botHex, event.content);

                let rawData;
                try {
                    rawData = JSON.parse(decrypted);
                } catch (e) {
                    // Fallback if not JSON
                    rawData = { content: decrypted, title: "Private Insight" };
                }

                // Normalizing: Ensure it's an array
                const items = Array.isArray(rawData) ? rawData : [rawData];

                // Process each insight
                for (let i = 0; i < items.length; i++) {
                    const postData = items[i];

                    // Improved ID logic: Prioritize payload ID, fallback to EventID + index
                    const uniqueId = postData.id || `${event.id}_${i}`;

                    // Normalizing to our Feed Format
                    const feedPost = {
                        id: uniqueId,
                        title: postData.title || "ü§ñ AI Insight",
                        content: postData.content || "",
                        tags: postData.tags || ["insight", "ai"],
                        feedName: "AI_Curator", // Required for backend file saving
                        author: {
                            name: "Personal AI",
                            handle: "ai_bot",
                            avatar: `https://api.dicebear.com/7.x/bottts/svg?seed=${BOT_NPUB}`
                        },
                        // Use payload ID for timestamp/sort if it mimics YYYYMMDD..., else Event Time
                        timestamp: postData.id || (event.created_at * 1000),
                        isInsight: true
                    };

                    // Add to Global Store (CRITICAL fix for Interaction/Like button)
                    window.postsById[feedPost.id] = feedPost;

                    renderSinglePost(feedPost, true); // true = prepend
                }

            } catch (e) {
                console.warn("Failed to decrypt/process insight:", e);
                // On failure, maybe don't mark as processed so we retry? 
                // But usually failure is permanent (bad key/format), so ignoring is safer to avoid loops.
            }
        }

        // --- 3. FETCH AND RENDER STATIC FEED ---
        async function loadFeed() {
            // Check for file protocol which blocks fetch
            if (window.location.protocol === 'file:') {
                document.getElementById('feed-container').innerHTML =
                    `<div class="p-4 text-center text-red-400 border border-red-500 rounded m-4">
                        <h3 class="font-bold">‚ö†Ô∏è Local File Access Error</h3>
                        <p class="mt-2 text-sm text-slate-300">Browsers cannot "fetch" JSON files directly from the file system (file://) due to security rules ("CORS").</p>
                        <p class="mt-4 text-sm font-mono bg-slate-800 p-2 rounded">Run ./start_server.sh</p>
                        <p class="mt-2 text-sm">Or use python -m http.server 8000</p>
                    </div>`;
                return;
            }

            try {
                const feedFiles = await getFeedFiles();
                const feedPromises = feedFiles.map(async (file) => {
                    const response = await fetch(file);
                    if (!response.ok) throw new Error(`Failed to load ${file}`);
                    const data = await response.json();

                    // Extract name from filename: "feed/AI_Curator_feed.json" -> "AI_Curator" -> "AI Curator"
                    const filename = file.split('/').pop(); // "AI_Curator_feed.json"
                    const namePart = filename.replace('_feed.json', ''); // "AI_Curator"
                    const authorName = namePart.replace(/_/g, ' '); // "AI Curator"

                    // Generate consistent avatar seed from name
                    let hash = 0;
                    for (let i = 0; i < authorName.length; i++) {
                        hash = authorName.charCodeAt(i) + ((hash << 5) - hash);
                    }
                    const avatarUrl = `https://api.dicebear.com/7.x/bottts/svg?seed=${Math.abs(hash)}`;

                    // Inject author meta into each post
                    return data.map(post => {
                        return {
                            ...post,
                            feedName: namePart, // Store the raw feed name for filenames
                            author: {
                                name: authorName,
                                avatar: avatarUrl,
                                handle: ""
                            },
                            // Use ID for sorting (YYYYMMDDHHMM)
                            timestamp: post.id
                        };
                    });
                });

                const results = await Promise.all(feedPromises);
                const allPosts = results.flat();

                // Sort by ID descending (works for YYYYMMDDHHMM strings)
                allPosts.sort((a, b) => b.id.localeCompare(a.id));

                // Populate Global Store
                window.postsById = {};
                allPosts.forEach(post => {
                    window.postsById[post.id] = post;
                });

                renderPosts(allPosts);

                // Attempt to load insights if already logged in
                setTimeout(fetchInsights, 1000);

            } catch (err) {
                console.error("Error loading feeds:", err);
                document.getElementById('feed-container').innerHTML =
                    `<div class="p-4 text-center text-red-400">Error loading feed. <br><small class="text-slate-500">${err.message}</small></div>`;
            }
        }


        function renderPosts(posts) {
            const container = document.getElementById('feed-container');
            container.innerHTML = ''; // Clear loading

            // Filter out hidden posts from localStorage
            const hiddenPosts = JSON.parse(localStorage.getItem('hiddenPosts') || '[]');
            const visiblePosts = posts.filter(post => !hiddenPosts.includes(post.id));

            visiblePosts.forEach(post => {
                renderSinglePost(post, false);
            });
        }

        function renderSinglePost(post, prepend = false) {
            const container = document.getElementById('feed-container');
            const existing = document.getElementById(`post-${post.id}`);
            if (existing) return;

            // Timestamp parsing
            let timeStr = "";
            if (typeof post.timestamp === 'number') { // UNIX timestamp from Nostr
                timeStr = new Date(post.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else { // YYYYMMDD string
                const year = post.id.substring(0, 4);
                const month = post.id.substring(4, 6);
                const day = post.id.substring(6, 8);
                const hour = post.id.substring(8, 10);
                const minute = post.id.substring(10, 12);
                const dateObj = new Date(`${year}-${month}-${day}T${hour}:${minute}:00`);
                timeStr = isNaN(dateObj) ? "" : dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }

            // Special Styling for Insights
            const bgClass = post.isInsight ? "bg-indigo-900/30 border-indigo-500/50" : "border-slate-800 hover:bg-slate-800/50";
            const icon = post.isInsight ? "‚ú®" : "";

            const html = `
                <div id="post-${post.id}" class="border-b ${bgClass} p-4 transition duration-200">
                    <div class="flex gap-3">
                        <img src="${post.author.avatar}" class="w-12 h-12 rounded-full bg-slate-700 object-cover flex-shrink-0">
                        
                        <div class="flex-1 min-w-0">
                            <div class="flex items-baseline justify-between">
                                <div class="flex items-center gap-1 overflow-hidden">
                                    <span class="font-bold text-white truncate">${icon} ${post.author.name}</span>
                                    <span class="text-slate-500 text-sm truncate">${post.author.handle}</span>
                                    <span class="text-slate-500 text-sm">¬∑ ${timeStr}</span>
                                </div>
                            </div>

                            ${post.title ? `<h3 id="title-${post.id}" class="mt-1 font-bold text-base text-white">${post.title}</h3>` : ''}

                            <div id="content-${post.id}" class="mt-1 text-[15px] leading-normal text-slate-100 whitespace-pre-wrap outline-none focus:ring-1 focus:ring-blue-500/50 rounded px-1 -ml-1 transition" contenteditable="true">
                                ${linkify(post.content.trim())}
                                ${post.tags && post.tags.length > 0 ? `<div class="mt-2 text-blue-400 font-medium text-sm">${post.tags.map(t => `#${t}`).join(' ')}</div>` : ''}
                            </div>

                            <div class="mt-3 flex items-center justify-center gap-20 text-slate-500">
                                <button onclick="handleInteraction('like', '${post.id}')" class="group flex items-center gap-1.5 hover:text-pink-500 tap-highlight-transparent">
                                    <svg class="w-5 h-5 group-hover:bg-pink-500/10 rounded-full p-0.5 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                                </button>

                                <button onclick="handleInteraction('reply', '${post.id}')" class="group flex items-center gap-1.5 hover:text-blue-400 tap-highlight-transparent">
                                    <svg class="w-5 h-5 group-hover:bg-blue-500/10 rounded-full p-0.5 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;

            if (prepend) {
                container.insertAdjacentHTML('afterbegin', html);
            } else {
                container.insertAdjacentHTML('beforeend', html);
            }
        }

        // --- 3. HANDLE INTERACTIONS ---
        async function handleInteraction(type, postId) {
            const secret = localStorage.getItem("nostr_pubkey");

            if (!secret) {
                alert("üîí Please login with Nostr first!");
                return;
            }

            // Look up post in Global Store
            const post = window.postsById[postId];
            if (!post) {
                console.error("Error: Post not found in memory.");
                return;
            }

            let commentText = "";
            let postContent = "";

            if (type === 'reply') {
                commentText = prompt("Write your reply:");
                if (commentText === null) return; // Cancelled
            } else {
                const contentEl = document.getElementById(`content-${postId}`);
                postContent = contentEl ? contentEl.innerText : post.content;
            }

            // Prepared Payload
            const payload = {
                secret: secret,
                type: type,
                postId: postId,
                comment: commentText,
                postContent: postContent,      // Used for Like
                postTitle: post.title || "",   // From Store
                feedName: post.feedName || "", // From Store
                tags: post.tags || []          // From Store
            };

            console.log("üöÄ Sending Payload:", payload); // Debugging

            // Optimistic UI Update: Hide post immediately
            const postElement = document.getElementById(`post-${postId}`);
            if (postElement) {
                postElement.style.display = 'none';
            }

            // Update LocalStorage to keep it hidden on reload
            const hiddenPosts = JSON.parse(localStorage.getItem('hiddenPosts') || '[]');
            if (!hiddenPosts.includes(postId)) {
                hiddenPosts.push(postId);
                localStorage.setItem('hiddenPosts', JSON.stringify(hiddenPosts));
            }

            // Send to Google Script
            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                console.log("‚úÖ Request sent (result hidden by no-cors)");
            } catch (error) {
                console.error("Error sending data:", error);
            }
        }

        // Utilities
        function formatTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function linkify(text) {
            // Simple regex to make links clickable and highlight hashtags
            return text
                .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" class="text-blue-400 hover:underline" target="_blank" onclick="event.stopPropagation()">$1</a>')
                .replace(/#(\w+)/g, '<span class="text-blue-400 font-medium">#$1</span>');
        }

        // Init
        loadFeed();

        // Ensure NostrTools loaded check
        window.addEventListener('load', () => {
            updateLoginUI();
        });

    </script>
</body>

</html>